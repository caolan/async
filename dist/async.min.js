/*global setTimeout: false, console: false */(function(){var a=function(){this.does=function(a){return a()},this.undoes,this.finalizes=[],this.awaits=[];var a=this;this.run=function(b){return a.does=b,a},this.undo=function(b){return a.undoes=b,a},this.handle=function(b){return b||(b=function(a,b){return b(a)}),a.handler=b,a},this.finalize=function(b){return b=b instanceof Array?b:[b],e(b,function(b){j(a.finalizes,b)==-1&&a.finalizes.push(b)}),a},this.await=function(b){return b=b instanceof Array?b:[b],e(b,function(b){j(a.awaits,b)==-1&&a.awaits.push(b)}),a}},b={},c=this,d=c.async;typeof module!="undefined"&&module.exports?module.exports=b:c.async=b,b.noConflict=function(){return c.async=d,b};var e=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)},f=function(a,b){if(a.filter)return a.filter(b);var c=[];return e(a,function(a){b(a)&&c.push(a)}),c},g=function(a,b){if(a.map)return a.map(b);var c=[];return e(a,function(a,d,e){c.push(b(a,d,e))}),c},h=function(a,b,c){return a.reduce?a.reduce(b,c):(e(a,function(a,d,e){c=b(c,a,d,e)}),c)},i=function(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},j=function(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0;c<a.length;c+=1)if(a[c]===b)return c;return-1};typeof process=="undefined"||!process.nextTick?b.nextTick=function(a){setTimeout(a,0)}:b.nextTick=process.nextTick,b.task=function(){return new a},b.forEach=function(a,b,c){if(!a.length)return c();var d=0;e(a,function(e){b(e,function(b){b?(c(b),c=function(){}):(d+=1,d===a.length&&c())})})},b.forEachSeries=function(a,b,c){if(!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d===a.length?c():e())})};e()},b.forEachLimit=function(a,b,c,d){if(!a.length||b<=0)return d();var e=0,f=0,g=0;(function h(){if(e===a.length)return d();while(g<b&&f<a.length)c(a[f],function(b){b?(d(b),d=function(){}):(e+=1,g-=1,e===a.length?d():h())}),f+=1,g+=1})()};var k=function(a){return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,[b.forEach].concat(c))}},l=function(a){return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,[b.forEachSeries].concat(c))}},m=function(a,b,c,d){var e=[];b=g(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})};b.map=k(m),b.mapSeries=l(m),b.reduce=function(a,c,d,e){b.forEachSeries(a,function(a,b){d(c,a,function(a,d){c=d,b(a)})},function(a){e(a,c)})},b.inject=b.reduce,b.foldl=b.reduce,b.reduceRight=function(a,c,d,e){var f=g(a,function(a){return a}).reverse();b.reduce(f,c,d,e)},b.foldr=b.reduceRight;var n=function(a,b,c,d){var e=[];b=g(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c&&e.push(a),b()})},function(a){d(g(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};b.filter=k(n),b.filterSeries=l(n),b.select=b.filter,b.selectSeries=b.filterSeries;var o=function(a,b,c,d){var e=[];b=g(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c||e.push(a),b()})},function(a){d(g(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};b.reject=k(o),b.rejectSeries=l(o);var p=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?(d(a),d=function(){}):b()})},function(a){d()})};b.detect=k(p),b.detectSeries=l(p),b.some=function(a,c,d){b.forEach(a,function(a,b){c(a,function(a){a&&(d(!0),d=function(){}),b()})},function(a){d(!1)})},b.any=b.some,b.every=function(a,c,d){b.forEach(a,function(a,b){c(a,function(a){a||(d(!1),d=function(){}),b()})},function(a){d(!0)})},b.all=b.every,b.sortBy=function(a,c,d){b.map(a,function(a,b){c(a,function(c,d){c?b(c):b(null,{value:a,criteria:d})})},function(a,b){if(a)return d(a);var c=function(a,b){var c=a.criteria,d=b.criteria;return c<d?-1:c>d?1:0};d(null,g(b.sort(c),function(a){return a.value}))})},b.auto=function(c,d){d=d||function(){};var f=i(c);if(!f.length)return d(null);var g={},k={},l={},m=[],n=[],o=[],p={},q=function(a){n.push(a)},r=function(a){for(var b=0;b<n.length;b++)if(n[b]===a){n.splice(b,1);return}},s=function(){e(n.slice(0),function(a){a()})},t=function(){var a={},c={};e(m,function(d){if(p.hasOwnProperty(d.key)||!d.undoes||j(o,d.key)===-1)return;a[d.key]=b.task().run(function(a,b){d.undoes(g,a,b)}),e(i(p),function(a){p[a]==d&&delete p[a]}),e(d.awaits,function(a){if(p.hasOwnProperty(a)||j(o,a)==-1)return;(c.hasOwnProperty(a)?c[a]:c[a]=[]).push(d.key)})}),e(i(c),function(b){a[b].await(c[b])}),b.auto(a,function(a,b){d(g)})},u=function(){};q(function(){i(k).length===f.length&&(d(null,k),d=function(){})}),e(f,function(d){var f;c[d]instanceof a?f=c[d]:c[d]=f=c[d]instanceof Function?b.task().run(c[d]):b.task().run(c[d].pop()).await(c[d]),f.key=d,e(f.finalizes,function(a){j(o,a)===-1&&o.push(a)});var n=function(a){if(a)g[d]=a;else{m.unshift(c[d]),e(f.finalizes,function(a){c[a].finalized=!0,p[a]=p[a]||f});var h=Array.prototype.slice.call(arguments,1);h.length<=1&&(h=h[0]),k[d]=h}delete l[d],b.nextTick(function(){i(g).length?i(l).length===0&&(t(),t=function(){}):s()})},u=function(){return h(f.awaits,function(a,b){return a&&k.hasOwnProperty(b)},!0)},v=function(){if(u()){l[d]=f,r(v);if(f.handler)try{f.does(n,k)}catch(a){f.handler(a,n)}else f.does(n,k)}};q(v),b.nextTick(s)})},b.waterfall=function(a,c){if(!a.length)return c();c=c||function(){};var d=function(a){return function(e){if(e)c(e),c=function(){};else{var f=Array.prototype.slice.call(arguments,1),g=a.next();g?f.push(d(g)):f.push(c),b.nextTick(function(){a.apply(null,f)})}}};d(b.iterator(a))()},b.parallel=function(a,c){c=c||function(){};if(a.constructor===Array)b.map(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};b.forEach(i(a),function(b,c){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[b]=e,c(a)})},function(a){c(a,d)})}},b.series=function(a,c){c=c||function(){};if(a.constructor===Array)b.mapSeries(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};b.forEachSeries(i(a),function(b,c){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[b]=e,c(a)})},function(a){c(a,d)})}},b.iterator=function(a){var b=function(c){var d=function(){return a.length&&a[c].apply(null,arguments),d.next()};return d.next=function(){return c<a.length-1?b(c+1):null},d};return b(0)},b.apply=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};var q=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]),b(a)})},function(a){d(a,e)})};b.concat=k(q),b.concatSeries=l(q),b.whilst=function(a,c,d){a()?c(function(e){if(e)return d(e);b.whilst(a,c,d)}):d()},b.until=function(a,c,d){a()?d():c(function(e){if(e)return d(e);b.until(a,c,d)})},b.queue=function(a,c){var d=0,f={tasks:[],concurrency:c,saturated:null,empty:null,drain:null,push:function(a,d){a.constructor!==Array&&(a=[a]),e(a,function(a){f.tasks.push({data:a,callback:typeof d=="function"?d:null}),f.saturated&&f.tasks.length==c&&f.saturated(),b.nextTick(f.process)})},process:function(){if(d<f.concurrency&&f.tasks.length){var b=f.tasks.shift();f.empty&&f.tasks.length==0&&f.empty(),d+=1,a(b.data,function(){d-=1,b.callback&&b.callback.apply(b,arguments),f.drain&&f.tasks.length+d==0&&f.drain(),f.process()})}},length:function(){return f.tasks.length},running:function(){return d}};return f};var r=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);typeof console!="undefined"&&(b?console.error&&console.error(b):console[a]&&e(c,function(b){console[a](b)}))}]))}};b.log=r("log"),b.dir=r("dir"),b.memoize=function(a,b){var c={},d={};b=b||function(a){return a};var e=function(){var e=Array.prototype.slice.call(arguments),f=e.pop(),g=b.apply(null,e);g in c?f.apply(null,c[g]):g in d?d[g].push(f):(d[g]=[f],a.apply(null,e.concat([function(){c[g]=arguments;var a=d[g];delete d[g];for(var b=0,e=a.length;b<e;b++)a[b].apply(null,arguments)}])))};return e.unmemoized=a,e},b.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}}})();