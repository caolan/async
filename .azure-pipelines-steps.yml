# Build steps common to all platforms

steps:
- task: NodeTool@0
  inputs:
    versionSpec: $(node_version)
  displayName: 'Install Node.js'

- task: Npm@1
  inputs:
    command: custom
    customCommand: i -g npm
  displayName: 'Update npm'
  condition: eq(variables['node_version'], '6.x')

- task: Npm@1
  inputs:
    command: custom
    customCommand: ci
  displayName: 'Install dependencies'

- bash: |
    npm test -- -- --reporter mocha-junit-reporter --reporter-options mochaFile=./test-results.xml
  displayName: 'Run tests'

- task: PublishTestResults@2
  inputs:
    testResultsFiles: '**/test-results.xml'
    testRunTitle: $(os_name) Node $(node_version)
  displayName: 'Publishing the test results'
  condition: always()

- bash: |
      export DISPLAY=:99.0
      make -j 4
      npm run mocha-browser-test
  displayName: 'Run Firefox tests'
  condition: |
    and(
      eq(variables['node_version'], '10.x'),
      in(variables['os_name'], 'Linux', 'Windows')
    )

- bash: npm run mocha-browser-test -- --browsers Safari
  displayName: 'Run Safari tests'
  condition: |
    and(
      eq(variables['node_version'], '10.x'),
      in(variables['os_name'], 'OSX')
    )

- task: PublishTestResults@2
  inputs:
    testResultsFiles: '**/browser-test-results.xml'
    testRunTitle: $(os_name) Node $(node_version) Browser tests
  displayName: 'Publishing the browser test results'
  condition: eq(variables['node_version'], '10.x')
 
- bash: |
    export COVERALLS_REPO_TOKEN=$(COVERALLS_REPO_TOKEN)
    npm run coveralls
  displayName: 'Run coveralls'
  condition: |
    and(
      eq(variables['node_version'], '10.x'),
      in(variables['os_name'], 'Linux', 'Windows')
    )
